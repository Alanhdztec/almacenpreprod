//- ========================================
//- VIEWS/INVENTORY/OFICIALIA/INDEX.PUG - SOLO OFICIALÍA
//- ========================================

extends ../../layouts/main

block content
  .min-h-screen.bg-gray-50
    //- Header específico para Oficialía
    header.bg-white.shadow
      div(class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8")
        .flex.justify-between.items-center.py-6
          .flex.items-center
            button.menu-toggle(
              type="button" 
              id="sidebarToggle"
              class="mr-3 p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition duration-150 ease-in-out"
              title="Abrir menú"
            )
              svg.h-6.w-6(fill="none", stroke="currentColor", viewBox="0 0 24 24")
                path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M4 6h16M4 12h16M4 18h16")
            //- Icono específico para oficialía
            svg.h-8.w-8.text-emerald-600.mr-3(fill="currentColor", viewBox="0 0 20 20")
              path(fill-rule="evenodd", d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zm-2 5v5a2 2 0 002 2h12a2 2 0 002-2V9H2zm8 2a1 1 0 011 1v1.586l.293-.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 111.414-1.414L9 13.586V12a1 1 0 011-1z", clip-rule="evenodd")
            
            h1.text-2xl.font-bold.text-gray-900 Inventario 
            
          .flex.items-center.space-x-4
            .text-sm.text-gray-700
              span.font-medium #{user.nombres}
            
            form(action="/auth/logout", method="POST", style="display: inline;")
              button(
                type="submit"
                title="Cerrar sesión"
                class="bg-pink-600 hover:bg-pink-700 text-white p-2 rounded-md transition duration-150 ease-in-out"
              )
                svg(xmlns="http://www.w3.org/2000/svg", fill="none", viewBox="0 0 24 24", stroke-width="1.5", stroke="currentColor", class="w-5 h-5")
                  path(stroke-linecap="round", stroke-linejoin="round", d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9")
                  
    //- Overlay para cerrar sidebar en móvil
    div(id="sidebarOverlay" class="fixed inset-0 bg-transparent  z-40 hidden lg:hidden")

    //- Sidebar
    aside(id="sidebar" class="fixed inset-y-0 left-0 z-50 w-80 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0 lg:z-auto lg:shadow-none lg:w-80")
      .flex.flex-col.h-full
        
        //- Header del sidebar
        .flex.items-center.justify-between.px-6.py-4.bg-gray-50.border-b.border-gray-200
          .flex.items-center
            svg.h-6.w-6.text-emerald-600.mr-2(fill="currentColor", viewBox="0 0 20 20")
              path(fill-rule="evenodd", d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z", clip-rule="evenodd")
            h2.text-lg.font-semibold.text-gray-900 Historial de vales
          
          //- Botón cerrar (solo visible en móvil)
          button(id="closeSidebar" class="lg:hidden p-1 rounded-md text-gray-400 hover:text-gray-600 hover:bg-gray-100")
            svg.h-6.w-6(fill="none", stroke="currentColor", viewBox="0 0 24 24")
              path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M6 18L18 6M6 6l12 12")
        
        //- Navegación del sidebar
        nav.flex-1.px-4.py-4.space-y-2.overflow-y-auto
          
          //- Sección: Vales de Entrada
          .space-y-1
            .px-2.py-1.text-xs.font-semibold.text-gray-500.uppercase.tracking-wide
              | Vales de Entrada
            
            a.sidebar-link(
              href="/entry-ticket/oficialia/history"
              class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900 transition duration-150 ease-in-out"
            )
              svg.h-5.w-5.mr-3.text-gray-400(fill="none", stroke="currentColor", viewBox="0 0 24 24")
                path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z")
              | Historial de Vales de Entrada
          
            
          //- Divisor
          .border-t.border-gray-200.my-4
          
          //- Sección: Vales de Salida
          .space-y-1
            .px-2.py-1.text-xs.font-semibold.text-gray-500.uppercase.tracking-wide
              | Vales de Salida
            
            a.sidebar-link(
              href="/exit-ticket/oficialia/history"
              class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900 transition duration-150 ease-in-out"
            )
              svg.h-5.w-5.mr-3.text-gray-400(fill="none", stroke="currentColor", viewBox="0 0 24 24")
                path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z")
              | Historial de Vales de Salida
           
            
          //- Divisor
          .border-t.border-gray-200.my-4
          
          //- Sección: Inventario
          .space-y-1
            .px-2.py-1.text-xs.font-semibold.text-gray-500.uppercase.tracking-wide
              | Inventario
            
            a.sidebar-link(
              href="/inventario/oficialia"
              class="flex items-center px-3 py-2 text-sm font-medium text-emerald-700 bg-emerald-50 rounded-md"
            )
              svg.h-5.w-5.mr-3.text-emerald-500(fill="currentColor", viewBox="0 0 20 20")
                path(fill-rule="evenodd", d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zm-2 5v5a2 2 0 002 2h12a2 2 0 002-2V9H2zm8 2a1 1 0 011 1v1.586l.293-.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 111.414-1.414L9 13.586V12a1 1 0 011-1z", clip-rule="evenodd")
              | Ver Inventario

            if user.rol === 'Jefe_almacen'
            //- Divisor
            .border-t.border-gray-200.my-4
            
            .space-y-1
              .px-2.py-1.text-xs.font-semibold.text-gray-500.uppercase.tracking-wide
                | Acciones de Inventario
              
              a.sidebar-link(
                href="/inventario/oficialia/acciones"
                class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900 transition duration-150 ease-in-out"
              )
                svg.h-5.w-5.mr-3.text-gray-400(fill="currentColor", viewBox="0 0 20 20")
                  path(fill-rule="evenodd", d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z", clip-rule="evenodd")
                | Gestionar Inventario
              
              a.sidebar-link(
                href="/inventario/oficialia/acciones/productos-criticos"
                class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900 transition duration-150 ease-in-out"
              )
                svg.h-5.w-5.mr-3.text-red-400(fill="currentColor", viewBox="0 0 20 20")
                  path(fill-rule="evenodd", d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z", clip-rule="evenodd")
                | Stock Crítico
            
            a.sidebar-link(
              href="/inventario/reportes"
              class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900 transition duration-150 ease-in-out"
            )
              svg.h-5.w-5.mr-3.text-gray-400(fill="none", stroke="currentColor", viewBox="0 0 24 24")
                path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z")
              | Reportes
        
        //- Footer del sidebar
        .px-4.py-4.border-t.border-gray-200.bg-gray-50
          .flex.items-center.justify-between.text-xs.text-gray-500
            span Sistema de Almacén
            span v1.0


    //- Filtros específicos para oficialía
    div(class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6")      
      .bg-white.rounded-lg.shadow.p-6.mb-6
        .grid.grid-cols-2.gap-4.mb-4
          a(
            href="/entry-ticket/oficialia/create"
            class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-3 rounded-md text-sm font-medium transition duration-150 ease-in-out flex items-center justify-center"
          )
            svg.h-4.w-4.mr-2(fill="none", stroke="currentColor", viewBox="0 0 24 24")
              path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M12 6v6m0 0v6m0-6h6m-6 0H6")
            | Vale de Entrada
          
          a(
            href="/exit-ticket/oficialia/create"
            class="bg-pink-600 hover:bg-pink-700 text-white px-4 py-3 rounded-md text-sm font-medium transition duration-150 ease-in-out flex items-center justify-center"
          )
            svg.h-4.w-4.mr-2(fill="none", stroke="currentColor", viewBox="0 0 24 24")
              path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M12 6v6m0 0v6m0-6h6m-6 0H6")
            | Vale de Salida 

        h2.text-lg.font-semibold.text-gray-900.mb-4 Filtros de Búsqueda
        form(id="filterForm" class="grid grid-cols-1 md:grid-cols-3 gap-4" method="GET")
          .space-y-1
            label.block.text-sm.font-medium.text-gray-700(for="search") Nombre del Producto
            input(
              type="text"
              id="search"
              name="search"
              value=search || ''
              placeholder="Buscar por nombre..."
              class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
            )
          
          .space-y-1
            label.block.text-sm.font-medium.text-gray-700(for="partida") Partida Presupuestal
            select(
              id="partida"
              name="partida"
              class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
            )
              option(value="") Todas las partidas
              each partida in partidas
                option(value=partida.id_partida, selected=filters.partida == partida.id_partida)
                  | #{partida.clave_objeto_del_gasto} - #{partida.partida}
          
          .space-y-1.flex.items-end
            .flex.space-x-2
              button(
                type="submit"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out"
              )
                | Filtrar
              
              a(
                href="/inventario/oficialia"
                class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out"
              )
                | Limpiar
                
    //- Lista de productos de oficialía
    div(class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8")
      #productsContainer.space-y-4
        each product in products
          div(class="bg-white rounded-lg shadow hover:shadow-md transition-shadow duration-200 cursor-pointer product-card" data-product-id=product.id_producto_generico)
            .p-6
              .flex.items-center.justify-between
                .flex-1
                  h3.text-lg.font-semibold.text-gray-900.mb-2= product.producto_generico
                  
                  //- Grid específico para oficialía (solo muestra existencia_oficialia)
                  .div(class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm text-gray-600")
                    .space-y-1
                      .font-medium Partida:
                      .text-gray-900 #{product.clave_objeto_del_gasto}
                      .text-gray-700= product.partida
                    
                    .space-y-1
                      .font-medium Existencia :
                      div(class="cursor-pointer hover:bg-purple-50 p-2 rounded transition-colors" 
                          title="Existencia en oficialía")
                        span.text-lg.font-bold.text-purple-800= product.existencia_oficialia || 0
                        span.ml-1.text-xs.text-purple-600 Pieza(s)
                
                .flex-shrink-0.ml-4
                  svg.h-5.w-5.text-gray-400(fill="none", stroke="currentColor", viewBox="0 0 24 24")
                    path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M9 5l7 7-7 7")


      //- Loading y mensajes
      #loadingIndicator.hidden.text-center.py-8
        .inline-flex.items-center.px-4.py-2.font-semibold.leading-6.text-sm.shadow.rounded-md.text-purple-500.bg-purple-100.transition.ease-in-out.duration-150
          svg.animate-spin.-ml-1.mr-3.h-5.w-5.text-purple-500(fill="none", viewBox="0 0 24 24")
            circle.opacity-25(cx="12", cy="12", r="10", stroke="currentColor", stroke-width="4")
            path.opacity-75(fill="currentColor", d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z")
          | Cargando más productos...

      #noMoreProducts.hidden.text-center.py-8.text-gray-500
        p No hay más productos para mostrar

      if products.length === 0
        .text-center.py-12
          svg.mx-auto.h-12.w-12.text-gray-400(fill="none", stroke="currentColor", viewBox="0 0 24 24")
            path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2M4 13h2m13-8v2m0 0V5a2 2 0 00-2-2H9a2 2 0 00-2 2v2m0 0h10")
          h3.mt-2.text-sm.font-medium.text-gray-900 No se encontraron productos
          p.mt-1.text-sm.text-gray-500 No hay productos que coincidan con los filtros aplicados.

  //- Script específico para oficialía
  script.
    document.addEventListener('DOMContentLoaded', function() {
      let currentPage = parseInt('#{pagination.paginaActual}') || 1;
      let isLoading = false;
      let hasMore = currentPage < parseInt('#{pagination.totalPaginas}') || false;
      
      const productsContainer = document.getElementById('productsContainer');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const noMoreProducts = document.getElementById('noMoreProducts');
      
      async function loadMoreProducts() {
        if (isLoading || !hasMore) return;
        
        isLoading = true;
        loadingIndicator.classList.remove('hidden');
        
        try {
          const urlParams = new URLSearchParams(window.location.search);
          urlParams.set('pagina', currentPage + 1);
          
          const response = await fetch(`/inventario/oficialia/api/products?${urlParams.toString()}`);
          const data = await response.json();
          
          if (data.success && data.products.length > 0) {
            data.products.forEach(product => {
              const productCard = createOficialiaProductCard(product);
              productsContainer.appendChild(productCard);
            });
            
            currentPage = data.pagination.paginaActual;
            hasMore = currentPage < data.pagination.totalPaginas;
            
            if (!hasMore) {
              noMoreProducts.classList.remove('hidden');
            }
          } else {
            hasMore = false;
            noMoreProducts.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Error al cargar productos de oficialía:', error);
          hasMore = false;
        } finally {
          isLoading = false;
          loadingIndicator.classList.add('hidden');
        }
      }
      
      function createOficialiaProductCard(product) {
        const card = document.createElement('div');
        
        card.className = 'bg-white rounded-lg shadow hover:shadow-md transition-shadow duration-200 cursor-pointer product-card';
        card.setAttribute('data-product-id', product.id_producto_generico);
        
        card.innerHTML = `
          <div class="p-6">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">${product.producto_generico}</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm text-gray-600">
                  <div class="space-y-1">
                    <div class="font-medium">Partida:</div>
                    <div class="text-gray-900">${product.clave_objeto_del_gasto}</div>
                    <div class="text-gray-700">${product.partida}</div>
                  </div>
                  
                  <div class="space-y-1">
                    <div class="font-medium">Existencia :</div>
                    <div class="cursor-pointer hover:bg-purple-50 p-2 rounded transition-colors">
                      <span class="text-lg font-bold text-purple-800">${product.existencia_oficialia || 0}</span>
                      <span class="ml-1 text-xs text-purple-600">Pieza(s)</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="flex-shrink-0 ml-4">
                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </div>
          </div>
        `;
        
        card.addEventListener('click', function() {
          window.location.href = `/inventario/oficialia/product/${product.id_producto_generico}`;
        });
        
        return card;
      }
      
      // Scroll infinito
      let timeoutId;
      window.addEventListener('scroll', function() {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(function() {
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
          const windowHeight = window.innerHeight;
          const documentHeight = document.documentElement.offsetHeight;
          
          if (scrollTop + windowHeight >= documentHeight - 200) {
            loadMoreProducts();
          }
        }, 100);
      });
      
      // Event listeners para productos existentes
      const existingProductCards = document.querySelectorAll('.product-card');
      existingProductCards.forEach(card => {
        card.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const productId = this.getAttribute('data-product-id');
          if (productId) {
            window.location.href = `/inventario/oficialia/product/${productId}`;
          }
        });
      });

        const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const closeSidebar = document.getElementById('closeSidebar');

      let sidebarOpen = false;

      function openSidebar() {
        sidebarOpen = true;
        sidebar.classList.remove('-translate-x-full');
        sidebar.classList.add('translate-x-0');
        sidebarOverlay.classList.remove('hidden');
        
        const icon = sidebarToggle.querySelector('svg');
        icon.style.transform = 'rotate(90deg)';
        icon.style.transition = 'transform 0.3s ease-in-out';
        
        if (window.innerWidth < 1024) {
          document.body.style.overflow = 'hidden';
        }
      }

      function closeSidebarFunc() {
        sidebarOpen = false;
        sidebar.classList.add('-translate-x-full');
        sidebar.classList.remove('translate-x-0');
        sidebarOverlay.classList.add('hidden');
        
        const icon = sidebarToggle.querySelector('svg');
        icon.style.transform = 'rotate(0deg)';
        
        document.body.style.overflow = '';
      }

      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
          if (sidebarOpen) {
            closeSidebarFunc();
          } else {
            openSidebar();
          }
        });
      }

      if (closeSidebar) {
        closeSidebar.addEventListener('click', closeSidebarFunc);
      }

      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebarFunc);
      }

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && sidebarOpen) {
          closeSidebarFunc();
        }
      });

      window.addEventListener('resize', function() {
        if (window.innerWidth >= 1024) {
          document.body.style.overflow = '';
          sidebarOverlay.classList.add('hidden');
          sidebar.classList.remove('-translate-x-full');
          sidebar.classList.add('translate-x-0');
        } else if (sidebarOpen) {
          document.body.style.overflow = 'hidden';
        }
      });

      const currentPath = window.location.pathname;
      const sidebarLinks = document.querySelectorAll('.sidebar-link');

      sidebarLinks.forEach(link => {
        const href = link.getAttribute('href');
        
        if (href === currentPath) {
          link.classList.remove('text-gray-700', 'hover:bg-gray-100', 'hover:text-gray-900');
          link.classList.add('text-emerald-700', 'bg-emerald-50');
          
          const icon = link.querySelector('svg');
          if (icon) {
            icon.classList.remove('text-gray-400');
            icon.classList.add('text-emerald-500');
          }
        }
      });

      const filterForm = document.getElementById('filterForm');
      if (filterForm) {
        filterForm.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            return false;
          }
        });
      }

    });