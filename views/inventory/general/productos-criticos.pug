//- ========================================
//- VIEWS/INVENTORY/OFICIALIA/PRODUCTOS-CRITICOS.PUG - PRODUCTOS CON STOCK CRÍTICO
//- ========================================

extends ../../layouts/main

block content
  .min-h-screen.bg-gray-50
    //- Header
    header.bg-white.shadow
      div(class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8")
        .flex.justify-between.items-center.py-6
          .flex.items-center
            button.menu-toggle(
              type="button" 
              id="sidebarToggle"
              class="mr-3 p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition duration-150 ease-in-out"
              title="Abrir menú"
            )
              svg.h-6.w-6(fill="none", stroke="currentColor", viewBox="0 0 24 24")
                path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M4 6h16M4 12h16M4 18h16")
            
            //- Icono de alerta para productos críticos
            svg.h-8.w-8.text-red-600.mr-3(fill="currentColor", viewBox="0 0 20 20")
              path(fill-rule="evenodd", d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z", clip-rule="evenodd")
            
            h1.text-2xl.font-bold.text-gray-900 Productos con Stock Crítico
            span.ml-2.text-sm.text-white.bg-red-600.px-2.py-1.rounded-full= pagination.total
            
          .flex.items-center.space-x-4
            .text-sm.text-gray-700
              span.font-medium #{user.nombres}
            
            form(action="/auth/logout", method="POST", style="display: inline;")
              button(
                type="submit"
                title="Cerrar sesión"
                class="bg-pink-600 hover:bg-pink-700 text-white p-2 rounded-md transition duration-150 ease-in-out"
              )
                svg(xmlns="http://www.w3.org/2000/svg", fill="none", viewBox="0 0 24 24", stroke-width="1.5", stroke="currentColor", class="w-5 h-5")
                  path(stroke-linecap="round", stroke-linejoin="round", d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9")
                  
    //- Overlay y sidebar (mismo que acciones inventario)
    div(id="sidebarOverlay" class="fixed inset-0 bg-transparent z-40 hidden lg:hidden")

    aside(id="sidebar" class="fixed inset-y-0 left-0 z-50 w-80 bg-white shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0 lg:z-auto lg:shadow-none lg:w-80")
      .flex.flex-col.h-full
        .flex.items-center.justify-between.px-6.py-4.bg-gray-50.border-b.border-gray-200
          .flex.items-center
            svg.h-6.w-6.text-indigo-600.mr-2(fill="currentColor", viewBox="0 0 20 20")
              path(fill-rule="evenodd", d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z", clip-rule="evenodd")
            h2.text-lg.font-semibold.text-gray-900 Navegación
          
          button(id="closeSidebar" class="lg:hidden p-1 rounded-md text-gray-400 hover:text-gray-600 hover:bg-gray-100")
            svg.h-6.w-6(fill="none", stroke="currentColor", viewBox="0 0 24 24")
              path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M6 18L18 6M6 6l12 12")
        
        nav.flex-1.px-4.py-4.space-y-2.overflow-y-auto
          .space-y-1
            a.sidebar-link(
              href="/inventario/oficialia/acciones"
              class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900 transition duration-150 ease-in-out"
            )
              svg.h-5.w-5.mr-3.text-gray-400(fill="currentColor", viewBox="0 0 20 20")
                path(fill-rule="evenodd", d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z", clip-rule="evenodd")
              | ← Volver a Acciones
            
            a.sidebar-link(
              href="/inventario/oficialia"
              class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 hover:text-gray-900 transition duration-150 ease-in-out"
            )
              svg.h-5.w-5.mr-3.text-gray-400(fill="currentColor", viewBox="0 0 20 20")
                path(fill-rule="evenodd", d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4zm-2 5v5a2 2 0 002 2h12a2 2 0 002-2V9H2zm8 2a1 1 0 011 1v1.586l.293-.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 111.414-1.414L9 13.586V12a1 1 0 011-1z", clip-rule="evenodd")
              | Ver Inventario Completo
        
        .px-4.py-4.border-t.border-gray-200.bg-gray-50
          .flex.items-center.justify-between.text-xs.text-gray-500
            span Sistema de Almacén
            span v1.0

    //- Contenido principal
    div(class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6")
      
      //- Información de la página
      .bg-red-50.border-l-4.border-red-400.p-4.rounded-lg.mb-6
        .flex
          .flex-shrink-0
            svg.h-5.w-5.text-red-400(fill="currentColor", viewBox="0 0 20 20")
              path(fill-rule="evenodd", d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z", clip-rule="evenodd")
          .ml-3
            h3.text-sm.font-medium.text-red-800 Productos que Requieren Atención Inmediata
            .mt-2.text-sm.text-red-700
              p Esta lista incluye productos con existencias negativas, sin stock sugerido configurado, o con niveles críticos de inventario (menos del 24% del stock sugerido).

      //- Lista de productos críticos
      if products.length > 0
        .space-y-4
          each product in products
            div(class="bg-white rounded-lg shadow border-l-4 " + (product.stock_status === 'negative' ? 'border-red-600' : product.stock_status === 'critical' && product.stock_sugerido === 0 ? 'border-yellow-500' : 'border-orange-500'))
              .p-6
                .flex.items-center.justify-between
                  .flex-1
                    .flex.items-center.mb-3
                      //- Badge de estado
                      if product.stock_status === 'negative'
                        span.bg-red-100.text-red-800.text-xs.font-medium.mr-2.px-3.py-1.rounded Existencia Negativa
                      else if product.stock_sugerido === 0
                        span.bg-yellow-100.text-yellow-800.text-xs.font-medium.mr-2.px-3.py-1.rounded Sin Stock Configurado
                      else
                        span.bg-orange-100.text-orange-800.text-xs.font-medium.mr-2.px-3.py-1.rounded Stock Crítico
                      
                      h3.text-lg.font-semibold.text-gray-900= product.producto_generico
                    
                    .grid.grid-cols-1.md-grid-cols-5.gap-4.text-sm.text-gray-600
                      .space-y-1
                        .font-medium Partida:
                        .text-gray-900 #{product.clave_objeto_del_gasto}
                        .text-gray-700= product.partida
                      
                      .space-y-1
                        .font-medium Existencia Actual:
                        div(class="text-lg font-bold " + (product.existencia < 0 ? 'text-red-800' : 'text-purple-800'))
                          span= product.existencia
                          span.ml-1.text-xs.text-gray-600 unidades
                      
                      .space-y-1
                        .font-medium Stock Mínimo:
                        .text-gray-900 #{product.stock_min || 'No definido'}
                      
                      .space-y-1
                        .font-medium Stock Sugerido:
                        .text-gray-900 #{product.stock_sugerido || 'No definido'}
                      
                      .space-y-1
                        .font-medium Nivel de Stock:
                        if product.stock_status === 'negative'
                          .text-red-800.font-bold Negativo
                        else if product.stock_sugerido === 0
                          .text-yellow-800.font-bold Configurar stock
                        else
                          .text-orange-800.font-bold #{product.stock_percentage}%
                
                  .flex-shrink-0.ml-4
                    a(
                      href=`/inventario/oficialia/product/${product.id_producto_generico}`
                      class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out"
                    )
                      | Ver Detalles

        //- Paginación
        if pagination.totalPaginas > 1
          .mt-8.flex.items-center.justify-between
            .flex-1.flex.justify-between.sm-hidden
              if pagination.paginaActual > 1
                a(
                  href=`?pagina=${pagination.paginaActual - 1}`
                  class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                )
                  | Anterior
              if pagination.paginaActual < pagination.totalPaginas
                a(
                  href=`?pagina=${pagination.paginaActual + 1}`
                  class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                )
                  | Siguiente
            
            .hidden.sm-flex-1.sm-flex.sm-items-center.sm-justify-between
              div
                p.text-sm.text-gray-700
                  | Mostrando 
                  span.font-medium #{((pagination.paginaActual - 1) * 20) + 1}
                  |  a 
                  span.font-medium #{Math.min(pagination.paginaActual * 20, pagination.total)}
                  |  de 
                  span.font-medium #{pagination.total}
                  |  productos críticos
              
              div
                nav.relative.z-0.inline-flex.rounded-md.shadow-sm(-aria-label="Pagination")
                  if pagination.paginaActual > 1
                    a(
                      href=`?pagina=${pagination.paginaActual - 1}`
                      class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                    )
                      span.sr-only Anterior
                      svg.h-5.w-5(fill="currentColor", viewBox="0 0 20 20")
                        path(fill-rule="evenodd", d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z", clip-rule="evenodd")
                  
                  //- Páginas
                  - let startPage = Math.max(1, pagination.paginaActual - 2)
                  - let endPage = Math.min(pagination.totalPaginas, pagination.paginaActual + 2)
                  
                  if startPage > 1
                    a(
                      href="?pagina=1"
                      class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
                    ) 1
                    if startPage > 2
                      span.relative.inline-flex.items-center.px-4.py-2.border.border-gray-300.bg-white.text-sm.font-medium.text-gray-700 ...
                  
                  - for (let i = startPage; i <= endPage; i++)
                    if i === pagination.paginaActual
                      span(
                        class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-indigo-50 text-sm font-medium text-indigo-600"
                      )= i
                    else
                      a(
                        href=`?pagina=${i}`
                        class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
                      )= i
                  
                  if endPage < pagination.totalPaginas
                    if endPage < pagination.totalPaginas - 1
                      span.relative.inline-flex.items-center.px-4.py-2.border.border-gray-300.bg-white.text-sm.font-medium.text-gray-700 ...
                    a(
                      href=`?pagina=${pagination.totalPaginas}`
                      class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
                    )= pagination.totalPaginas
                  
                  if pagination.paginaActual < pagination.totalPaginas
                    a(
                      href=`?pagina=${pagination.paginaActual + 1}`
                      class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                    )
                      span.sr-only Siguiente
                      svg.h-5.w-5(fill="currentColor", viewBox="0 0 20 20")
                        path(fill-rule="evenodd", d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z", clip-rule="evenodd")

      else
        //- No hay productos críticos
        .text-center.py-12
          svg.mx-auto.h-12.w-12.text-green-400(fill="none", stroke="currentColor", viewBox="0 0 24 24")
            path(stroke-linecap="round", stroke-linejoin="round", stroke-width="2", d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z")
          h3.mt-2.text-sm.font-medium.text-gray-900 ¡Excelente! No hay productos críticos
          p.mt-1.text-sm.text-gray-500 Todos los productos del inventario de oficialía tienen niveles de stock adecuados.
          .mt-6
            a(
              href="/inventario/oficialia/acciones"
              class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700"
            )
              | Volver a Acciones de Inventario

  //- Script
  script.
    document.addEventListener('DOMContentLoaded', function() {
      // Funcionalidad del sidebar (igual que en acciones)
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      const closeSidebar = document.getElementById('closeSidebar');

      let sidebarOpen = false;

      function openSidebar() {
        sidebarOpen = true;
        sidebar.classList.remove('-translate-x-full');
        sidebar.classList.add('translate-x-0');
        sidebarOverlay.classList.remove('hidden');
        
        if (window.innerWidth < 1024) {
          document.body.style.overflow = 'hidden';
        }
      }

      function closeSidebarFunc() {
        sidebarOpen = false;
        sidebar.classList.add('-translate-x-full');
        sidebar.classList.remove('translate-x-0');
        sidebarOverlay.classList.add('hidden');
        document.body.style.overflow = '';
      }

      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
          if (sidebarOpen) {
            closeSidebarFunc();
          } else {
            openSidebar();
          }
        });
      }

      if (closeSidebar) {
        closeSidebar.addEventListener('click', closeSidebarFunc);
      }

      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', closeSidebarFunc);
      }

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && sidebarOpen) {
          closeSidebarFunc();
        }
      });

      window.addEventListener('resize', function() {
        if (window.innerWidth >= 1024) {
          document.body.style.overflow = '';
          sidebarOverlay.classList.add('hidden');
          sidebar.classList.remove('-translate-x-full');
          sidebar.classList.add('translate-x-0');
        } else if (sidebarOpen) {
          document.body.style.overflow = 'hidden';
        }
      });
    });